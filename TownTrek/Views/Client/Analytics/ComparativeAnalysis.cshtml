@model TownTrek.Models.ViewModels.ComparativeAnalysisResponse
@{
    ViewData["Title"] = "Comparative Analysis";
    ViewData["ActivePage"] = "Analytics";
}

<div class="analytics-container">
    <!-- Header -->
    <div class="analytics-header">
        <div class="header-content">
            <h1 class="analytics-title">Comparative Analysis</h1>
            <p class="analytics-subtitle">Compare performance across different time periods</p>
        </div>
        
        <!-- Comparison Controls -->
        <div class="comparison-controls">
            <div class="control-group">
                <label for="comparisonType">Comparison Type:</label>
                <select id="comparisonType" class="form-control">
                    <option value="WeekOverWeek">Week over Week</option>
                    <option value="MonthOverMonth" selected>Month over Month</option>
                    <option value="QuarterOverQuarter">Quarter over Quarter</option>
                    <option value="YearOverYear">Year over Year</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="platformFilter">Platform:</label>
                <select id="platformFilter" class="form-control">
                    <option value="All">All Platforms</option>
                    <option value="Web">Web Only</option>
                    <option value="Mobile">Mobile Only</option>
                    <option value="API">API Only</option>
                </select>
            </div>
            
            @if (ViewBag.BusinessId == null)
            {
                <div class="control-group">
                    <label for="businessFilter">Business:</label>
                    <select id="businessFilter" class="form-control">
                        <option value="">All Businesses</option>
                    </select>
                </div>
            }
            
            <button id="refreshComparison" class="btn btn-primary">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
    </div>

    <!-- Loading State -->
    <div id="comparisonLoading" class="loading-overlay" style="display: none;">
        <div class="loading-spinner">
            <i class="fas fa-chart-line"></i>
            <p>Loading comparison data...</p>
        </div>
    </div>

    <!-- Error State -->
    <div id="comparisonError" class="error-message" style="display: none;">
        <i class="fas fa-exclamation-triangle"></i>
        <p>Unable to load comparison data. Please try again.</p>
    </div>

    <!-- Comparison Overview -->
    <div class="comparison-overview">
        <div class="overview-grid">
            <!-- Overall Trend -->
            <div class="overview-card trend-card">
                <div class="card-header">
                    <h3>Overall Trend</h3>
                    <span class="trend-indicator @Model.ComparisonMetrics.OverallTrend.ToLower()">
                        @Model.ComparisonMetrics.OverallTrend
                    </span>
                </div>
                <div class="card-content">
                    <div class="trend-metrics">
                        <div class="metric">
                            <span class="label">Performance Rating:</span>
                            <span class="value @Model.ComparisonMetrics.PerformanceRating.ToLower()">
                                @Model.ComparisonMetrics.PerformanceRating
                            </span>
                        </div>
                        <div class="key-changes">
                            @foreach (var change in Model.ComparisonMetrics.KeyChanges.Take(3))
                            {
                                <span class="change-badge">@change</span>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Views Comparison -->
            <div class="overview-card">
                <div class="card-header">
                    <h3>Views</h3>
                    <span class="change-percent @(Model.ComparisonMetrics.ViewsChangePercent >= 0 ? "positive" : "negative")">
                        @(Model.ComparisonMetrics.ViewsChangePercent >= 0 ? "+" : "")@Model.ComparisonMetrics.ViewsChangePercent.ToString("F1")%
                    </span>
                </div>
                <div class="card-content">
                    <div class="comparison-stats">
                        <div class="stat">
                            <span class="label">Current Period:</span>
                            <span class="value">@Model.CurrentPeriod.TotalViews.ToString("N0")</span>
                        </div>
                        <div class="stat">
                            <span class="label">Previous Period:</span>
                            <span class="value">@Model.PreviousPeriod.TotalViews.ToString("N0")</span>
                        </div>
                        <div class="stat">
                            <span class="label">Avg/Day:</span>
                            <span class="value">@Model.CurrentPeriod.AverageViewsPerDay.ToString("F1")</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reviews Comparison -->
            <div class="overview-card">
                <div class="card-header">
                    <h3>Reviews</h3>
                    <span class="change-percent @(Model.ComparisonMetrics.ReviewsChangePercent >= 0 ? "positive" : "negative")">
                        @(Model.ComparisonMetrics.ReviewsChangePercent >= 0 ? "+" : "")@Model.ComparisonMetrics.ReviewsChangePercent.ToString("F1")%
                    </span>
                </div>
                <div class="card-content">
                    <div class="comparison-stats">
                        <div class="stat">
                            <span class="label">Current Period:</span>
                            <span class="value">@Model.CurrentPeriod.TotalReviews.ToString("N0")</span>
                        </div>
                        <div class="stat">
                            <span class="label">Previous Period:</span>
                            <span class="value">@Model.PreviousPeriod.TotalReviews.ToString("N0")</span>
                        </div>
                        <div class="stat">
                            <span class="label">Avg/Day:</span>
                            <span class="value">@Model.CurrentPeriod.AverageReviewsPerDay.ToString("F1")</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rating Comparison -->
            <div class="overview-card">
                <div class="card-header">
                    <h3>Average Rating</h3>
                    <span class="change-percent @(Model.ComparisonMetrics.RatingChangePercent >= 0 ? "positive" : "negative")">
                        @(Model.ComparisonMetrics.RatingChangePercent >= 0 ? "+" : "")@Model.ComparisonMetrics.RatingChangePercent.ToString("F1")%
                    </span>
                </div>
                <div class="card-content">
                    <div class="comparison-stats">
                        <div class="stat">
                            <span class="label">Current Period:</span>
                            <span class="value">@Model.CurrentPeriod.AverageRating.ToString("F1")</span>
                        </div>
                        <div class="stat">
                            <span class="label">Previous Period:</span>
                            <span class="value">@Model.PreviousPeriod.AverageRating.ToString("F1")</span>
                        </div>
                        <div class="stat">
                            <span class="label">Engagement Score:</span>
                            <span class="value">@Model.CurrentPeriod.EngagementScore.ToString("F1")</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Comparison Chart -->
    <div class="comparison-chart-section">
        <div class="section-header">
            <h2>Performance Comparison</h2>
            <p>@Model.ChartData.TimeRange comparison chart</p>
        </div>
        
        <div class="chart-container">
            <canvas id="comparisonChart" width="400" height="200"></canvas>
        </div>
        
        <div class="chart-legend">
            <div class="legend-item">
                <span class="legend-color" style="background-color: #33658a;"></span>
                <span class="legend-label">Current Period</span>
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background-color: #86bbd8;"></span>
                <span class="legend-label">Previous Period</span>
            </div>
        </div>
    </div>

    <!-- Period Details -->
    <div class="period-details">
        <div class="details-grid">
            <!-- Current Period Details -->
            <div class="period-card current-period">
                <div class="period-header">
                    <h3>Current Period</h3>
                    <span class="period-dates">
                        @Model.CurrentPeriod.StartDate.ToString("MMM dd") - @Model.CurrentPeriod.EndDate.ToString("MMM dd, yyyy")
                    </span>
                </div>
                <div class="period-stats">
                    <div class="stat-row">
                        <span class="stat-label">Total Views:</span>
                        <span class="stat-value">@Model.CurrentPeriod.TotalViews.ToString("N0")</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Total Reviews:</span>
                        <span class="stat-value">@Model.CurrentPeriod.TotalReviews.ToString("N0")</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Total Favorites:</span>
                        <span class="stat-value">@Model.CurrentPeriod.TotalFavorites.ToString("N0")</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Average Rating:</span>
                        <span class="stat-value">@Model.CurrentPeriod.AverageRating.ToString("F1")</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Engagement Score:</span>
                        <span class="stat-value">@Model.CurrentPeriod.EngagementScore.ToString("F1")</span>
                    </div>
                    @if (Model.CurrentPeriod.PeakDayDate.HasValue)
                    {
                        <div class="stat-row">
                            <span class="stat-label">Peak Day:</span>
                            <span class="stat-value">@Model.CurrentPeriod.PeakDayDate.Value.ToString("MMM dd") (@Model.CurrentPeriod.PeakDayViews views)</span>
                        </div>
                    }
                </div>
            </div>

            <!-- Previous Period Details -->
            <div class="period-card previous-period">
                <div class="period-header">
                    <h3>Previous Period</h3>
                    <span class="period-dates">
                        @Model.PreviousPeriod.StartDate.ToString("MMM dd") - @Model.PreviousPeriod.EndDate.ToString("MMM dd, yyyy")
                    </span>
                </div>
                <div class="period-stats">
                    <div class="stat-row">
                        <span class="stat-label">Total Views:</span>
                        <span class="stat-value">@Model.PreviousPeriod.TotalViews.ToString("N0")</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Total Reviews:</span>
                        <span class="stat-value">@Model.PreviousPeriod.TotalReviews.ToString("N0")</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Total Favorites:</span>
                        <span class="stat-value">@Model.PreviousPeriod.TotalFavorites.ToString("N0")</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Average Rating:</span>
                        <span class="stat-value">@Model.PreviousPeriod.AverageRating.ToString("F1")</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Engagement Score:</span>
                        <span class="stat-value">@Model.PreviousPeriod.EngagementScore.ToString("F1")</span>
                    </div>
                    @if (Model.PreviousPeriod.PeakDayDate.HasValue)
                    {
                        <div class="stat-row">
                            <span class="stat-label">Peak Day:</span>
                            <span class="stat-value">@Model.PreviousPeriod.PeakDayDate.Value.ToString("MMM dd") (@Model.PreviousPeriod.PeakDayViews views)</span>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Business Comparison (if applicable) -->
    @if (Model.BusinessData != null)
    {
        <div class="business-comparison">
            <div class="section-header">
                <h2>Business Comparison: @Model.BusinessData.BusinessName</h2>
                <p>How your business performs against benchmarks</p>
            </div>
            
            <div class="comparison-grid">
                <!-- Category Comparison -->
                <div class="comparison-card">
                    <div class="card-header">
                        <h3>Category Performance</h3>
                        <span class="performance-indicator @Model.BusinessData.CategoryComparison.CategoryPerformance.ToLower().Replace(" ", "-")">
                            @Model.BusinessData.CategoryComparison.CategoryPerformance
                        </span>
                    </div>
                    <div class="card-content">
                        <div class="benchmark-stats">
                            <div class="benchmark-item">
                                <span class="label">Views vs Category:</span>
                                <span class="value @(Model.BusinessData.CategoryComparison.ViewsVsCategory >= 0 ? "positive" : "negative")">
                                    @(Model.BusinessData.CategoryComparison.ViewsVsCategory >= 0 ? "+" : "")@Model.BusinessData.CategoryComparison.ViewsVsCategory.ToString("F1")%
                                </span>
                            </div>
                            <div class="benchmark-item">
                                <span class="label">Reviews vs Category:</span>
                                <span class="value @(Model.BusinessData.CategoryComparison.ReviewsVsCategory >= 0 ? "positive" : "negative")">
                                    @(Model.BusinessData.CategoryComparison.ReviewsVsCategory >= 0 ? "+" : "")@Model.BusinessData.CategoryComparison.ReviewsVsCategory.ToString("F1")%
                                </span>
                            </div>
                            <div class="benchmark-item">
                                <span class="label">Rating vs Category:</span>
                                <span class="value @(Model.BusinessData.CategoryComparison.RatingVsCategory >= 0 ? "positive" : "negative")">
                                    @(Model.BusinessData.CategoryComparison.RatingVsCategory >= 0 ? "+" : "")@Model.BusinessData.CategoryComparison.RatingVsCategory.ToString("F1")%
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Portfolio Comparison -->
                <div class="comparison-card">
                    <div class="card-header">
                        <h3>Portfolio Performance</h3>
                        <span class="portfolio-rank">Rank #@Model.BusinessData.PortfolioComparison.PortfolioRank of @Model.BusinessData.PortfolioComparison.TotalPortfolioBusinesses</span>
                    </div>
                    <div class="card-content">
                        <div class="benchmark-stats">
                            <div class="benchmark-item">
                                <span class="label">Views vs Portfolio:</span>
                                <span class="value @(Model.BusinessData.PortfolioComparison.ViewsVsPortfolio >= 0 ? "positive" : "negative")">
                                    @(Model.BusinessData.PortfolioComparison.ViewsVsPortfolio >= 0 ? "+" : "")@Model.BusinessData.PortfolioComparison.ViewsVsPortfolio.ToString("F1")%
                                </span>
                            </div>
                            <div class="benchmark-item">
                                <span class="label">Reviews vs Portfolio:</span>
                                <span class="value @(Model.BusinessData.PortfolioComparison.ReviewsVsPortfolio >= 0 ? "positive" : "negative")">
                                    @(Model.BusinessData.PortfolioComparison.ReviewsVsPortfolio >= 0 ? "+" : "")@Model.BusinessData.PortfolioComparison.ReviewsVsPortfolio.ToString("F1")%
                                </span>
                            </div>
                            <div class="benchmark-item">
                                <span class="label">Rating vs Portfolio:</span>
                                <span class="value @(Model.BusinessData.PortfolioComparison.RatingVsPortfolio >= 0 ? "positive" : "negative")">
                                    @(Model.BusinessData.PortfolioComparison.RatingVsPortfolio >= 0 ? "+" : "")@Model.BusinessData.PortfolioComparison.RatingVsPortfolio.ToString("F1")%
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Insights -->
    @if (Model.Insights.Any())
    {
        <div class="insights-section">
            <div class="section-header">
                <h2>Key Insights</h2>
                <p>Analysis of your performance trends</p>
            </div>
            
            <div class="insights-grid">
                @foreach (var insight in Model.Insights)
                {
                    <div class="insight-card">
                        <i class="fas fa-lightbulb"></i>
                        <p>@insight</p>
                    </div>
                }
            </div>
        </div>
    }

    <!-- Custom Range Comparison -->
    <div class="custom-range-section">
        <div class="section-header">
            <h2>Custom Range Comparison</h2>
            <p>Compare specific date ranges</p>
        </div>
        
        <div class="custom-range-form">
            <div class="form-row">
                <div class="form-group">
                    <label for="currentStart">Current Period Start:</label>
                    <input type="date" id="currentStart" class="form-control" />
                </div>
                <div class="form-group">
                    <label for="currentEnd">Current Period End:</label>
                    <input type="date" id="currentEnd" class="form-control" />
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="previousStart">Previous Period Start:</label>
                    <input type="date" id="previousStart" class="form-control" />
                </div>
                <div class="form-group">
                    <label for="previousEnd">Previous Period End:</label>
                    <input type="date" id="previousEnd" class="form-control" />
                </div>
            </div>
            <div class="form-actions">
                <button id="runCustomComparison" class="btn btn-primary">
                    <i class="fas fa-chart-line"></i> Run Comparison
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/lib/chart.js/chart.min.js"></script>
    <script src="~/js/modules/client/comparative-analytics.js"></script>
}

@section Styles {
    <link rel="stylesheet" href="~/css/modules/client/comparative-analytics.css" />
}
