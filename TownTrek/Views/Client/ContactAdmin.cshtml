@model TownTrek.Models.ViewModels.ContactAdminViewModel
@{
    ViewData["Title"] = "Contact Admin";
    Layout = "~/Views/Shared/_ClientLayout.cshtml";
}

@section Styles {
    <link rel="stylesheet" href="~/css/components/forms.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/components/cards.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/components/contact-admin.css" asp-append-version="true" />
}

<!-- Page Header -->
<div class="page-header">
    <div class="page-header-content">
        <div>
            <h1 class="page-title">Contact Admin</h1>
            <p class="page-description">Send a message to the administrators for support, feature requests, or to report issues.</p>
        </div>
    </div>
</div>

<div class="grid grid-2" style="gap: 2rem;">
    <!-- Contact Form -->
    <div class="admin-card">
        <div class="admin-card-header">
            <h3 class="admin-card-title">Send Message</h3>
            <p class="admin-card-description">Fill out the form below to contact our support team</p>
        </div>
        
        <form asp-action="ContactAdmin" method="post" id="contactAdminForm">
            @Html.AntiForgeryToken()
            
            <!-- Topic Selection -->
            <div class="form-group">
                <label asp-for="TopicId" class="form-label">Topic <span class="required">*</span></label>
                <select asp-for="TopicId" class="form-select" id="topicSelect" required>
                    <option value="">Select a topic...</option>
                    @foreach (var topic in Model.AvailableTopics)
                    {
                        <option value="@topic.Id" 
                                data-priority="@topic.Priority" 
                                data-color="@topic.ColorClass"
                                data-description="@topic.Description"
                                data-icon="@topic.IconClass">
                            @topic.Name
                        </option>
                    }
                </select>
                <span asp-validation-for="TopicId" class="form-error"></span>
            </div>

            <!-- Topic Details (populated via JavaScript) -->
            <div id="topicDetails" class="topic-details" style="display: none;">
                <div class="topic-info">
                    <div class="topic-icon">
                        <i id="topicIcon" class=""></i>
                    </div>
                    <div class="topic-content">
                        <div class="topic-name" id="topicName"></div>
                        <div class="topic-description" id="topicDescription"></div>
                        <div class="topic-priority">
                            Priority: <span id="topicPriority" class="badge"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Subject -->
            <div class="form-group">
                <label asp-for="Subject" class="form-label">Subject <span class="required">*</span></label>
                <input asp-for="Subject" type="text" class="form-input" placeholder="Brief description of your message" maxlength="200" required />
                <span asp-validation-for="Subject" class="form-error"></span>
                <div class="form-help">Maximum 200 characters</div>
            </div>

            <!-- Message -->
            <div class="form-group">
                <label asp-for="Message" class="form-label">Message <span class="required">*</span></label>
                <textarea asp-for="Message" class="form-textarea" rows="8" placeholder="Please provide detailed information about your request, issue, or feedback..." maxlength="2000" required></textarea>
                <span asp-validation-for="Message" class="form-error"></span>
                <div class="form-help">
                    <span id="messageCounter">0</span>/2000 characters
                </div>
            </div>

            <!-- Submit Button -->
            <div class="form-actions">
                <button type="submit" class="auth-btn auth-btn-cta" id="submitBtn">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                    </svg>
                    Send Message
                </button>
                <a asp-action="Dashboard" class="auth-btn auth-btn-secondary">Cancel</a>
            </div>
        </form>
    </div>

    <!-- Recent Messages -->
    <div class="admin-card">
        <div class="admin-card-header">
            <h3 class="admin-card-title">Your Recent Messages</h3>
            <p class="admin-card-description">Track your previous communications with administrators</p>
        </div>
        
        @if (Model.UserMessages.Any())
        {
            <div class="message-list">
                @foreach (var message in Model.UserMessages)
                {
                    <div class="message-item">
                        <div class="message-header">
                            <div class="message-topic">
                                <i class="@message.Topic.IconClass"></i>
                                @message.Topic.Name
                            </div>
                            <div class="message-status">
                                <span class="badge badge-@GetStatusClass(message.Status)">@message.Status</span>
                            </div>
                        </div>
                        <div class="message-subject">@message.Subject</div>
                        <div class="message-meta">
                            <span class="message-date">@message.CreatedAt.ToString("MMM dd, yyyy")</span>
                            <span class="message-priority">
                                <span class="badge badge-@GetPriorityClass(message.Priority)">@message.Priority</span>
                            </span>
                        </div>
                        @if (!string.IsNullOrEmpty(message.AdminResponse))
                        {
                            <div class="message-response">
                                <strong>Admin Response:</strong>
                                <p>@message.AdminResponse</p>
                                <small>Responded on @message.ResponseAt?.ToString("MMM dd, yyyy")</small>
                            </div>
                        }
                    </div>
                }
            </div>
        }
        else
        {
            <div class="empty-state">
                <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24" class="empty-state-icon">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                </svg>
                <h4 class="empty-state-title">No Messages Yet</h4>
                <p class="empty-state-description">Your previous messages with administrators will appear here.</p>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script src="~/js/modules/client/contact-admin.js" asp-append-version="true"></script>
}

@functions {
    private string GetStatusClass(string status)
    {
        return status.ToLower() switch
        {
            "open" => "info",
            "inprogress" => "warning",
            "resolved" => "success",
            "closed" => "secondary",
            _ => "secondary"
        };
    }
    
    private string GetPriorityClass(string priority)
    {
        return priority.ToLower() switch
        {
            "critical" => "danger",
            "high" => "danger",
            "medium" => "warning",
            "low" => "secondary",
            _ => "secondary"
        };
    }
}